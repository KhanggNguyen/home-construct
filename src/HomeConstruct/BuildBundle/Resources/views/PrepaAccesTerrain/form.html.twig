{% extends "@HomeConstructBuild/GrosOeuvre/base-forms-profiles-grosOeuvre.html.twig" %}

{% block content %}
    {% block button_return %}
        {% if refererIsAForm == true and grosOeuvre.prepaAccesTerrain is defined and grosOeuvre.prepaAccesTerrain is not null %}
            {% set retour = path('home_construct_prepa_acces_terrain_profile',{'id':grosOeuvre.prepaAccesTerrain.id}) %}
        {% else %}
            {% set retour = app.request.server.get('HTTP_REFERER') %}
        {% endif %}
        <div class="block_button_back">
            <a id="button_back"
               class=" btn btn-xl u-btn-lightblue-v3 g-width-160--md g-font-size-default g-ml-10"
               href="{{ retour }}" data-speed="350">
                <div id="icone_plus_add" class="fas fa-reply"></div>
                Retour
            </a>
        </div>
    {% endblock button_return %}

    {% block sub_content %}
        <div class="col-lg-9 g-mb-50">
            <!-- Info -->
            <div class="g-brd-around g-brd-gray-light-v4 rounded g-pa-30 g-mb-30">
                {{ form_start(form) }}
                <div class="row">
                    <div class="col-12">
                        <span class="d-block">{{ form_row(form.surfaceTerrain) }}</span>
                    </div>
                </div>
                <div class="row" id="block_bouton_enregistrer">
                    <div class="col-12">
                        <span class="d-block">{{ form_row(form.save) }}</span>
                    </div>
                </div>
                {{ form_end(form) }}
            </div>
            <!-- End Info -->
        </div>

        {% if grosOeuvre.prepaAccesTerrain is defined and grosOeuvre.prepaAccesTerrain is not null %}
            <div class="block_profile_with_estimation">
                <div class="row">
                    <div class="col-lg-8 g-mb-50">
                        <div class="g-brd-around g-brd-gray-light-v4 rounded g-pa-30 g-mb-30 ">
                            {{ form_start(formArbre) }}
                                {{ form_row(formArbre.typeArbre) }}
                                {{ form_row(formArbre.tailleArbre) }}
                                {{ form_row(formArbre.prixAbattageNettoyage) }}
                                <p><span id="valeur_abattageNettoyage"></span>€</p>
                                {{ form_row(formArbre.prixDessouchage) }}
                                <p><span id="valeur_dessouchage">€</span></p>
                                {{ form_row(formArbre.quantite) }}
                            {{ form_end(formArbre) }}
                        </div>
                    </div>
                    <div class="col-lg-4 block_estimation_prix">
                        <h4 class="titre_estimation text-center">
                            Estimation
                        </h4>
                        <h6><I> Données utilisés : </I></h6>
                        <ul class="liste_variables_estimation">
                            <h5 class="titre_sous_entite">
                                <div class="link_sous_entite" href="">
                                    Informations sur l'arbre :
                                </div>
                            </h5>
                            <li>
                                <span id="block_checked_type">

                                </span>
                                Prix du type de type d'arbre :
                                <b id="prix_type_arbre">

                                </b>
                            </li>
                            <li>
                                <span id="block_checked_abattagenettoyage">
                                    <i class="fas fa-check-circle variable-presente"></i>
                                </span>
                                Tarif d'abattage et de nettoyage : <b id="abattage_nettoyage">
                                </b>
                            </li>
                            <li>
                                <span id="block_checked_dessouchage">
                                    <i class="fas fa-check-circle variable-presente"></i>
                                </span>
                                Tarif de dessouchage : <b id="dessouchage"></b>
                            </li>
                        </ul>
                        <div id="prixArbre" class="block_affichage_prix text-center font-weight-bold g-font-size-30 border-dark border">

                        </div>
                        <I id="rappel">
                        </I>
                    </div>
                </div>
            </div>
            <div id="table_form_arbre">
                {{ include('@HomeConstructBuild/Default/complex-table-arbre.html.twig') }}
            </div>
            <div class="block_profile_with_estimation">
                <div class="row">
                    <div class="col-lg-8 g-mb-50">
                        <div  class="g-brd-around g-brd-gray-light-v4 rounded g-pa-30 g-mb-30">
                            {{ form_start(formTerrassement) }}

                            {{ form_end(formTerrassement) }}
                        </div>
                    </div>
                    <div class="col-lg-4 block_estimation_prix">
                        <h4 class="titre_estimation text-center">
                            Estimation
                        </h4>
                        <h6> <I> Données utilisés : </I></h6>
                        <ul class="liste_variables_estimation">
                            <h5 class="titre_sous_entite">
                                <div class="link_sous_entite" href="">
                                    Informations sur le terrassement :
                                </div>
                            </h5>
                            <li>
                                <span id="block_checked_location">
                                    <i class="fas fa-check-circle variable-presente"></i>
                                </span>
                                Cout de location véhicules :
                                <b id="cout-location">
                                     1000
                                </b>
                            </li>
                            <li>
                                <span id="block_checked_travaux">

                                </span>
                                Prix du type de travaux :
                                <b id="prix-travaux">

                                </b>
                            </li>
                            <li>
                                <span id="block_checked_evacuation">
                                </span>
                                Prix du type d'evacuation : <b id="prix-evacuation">
                                </b>
                            </li>
                        </ul>
                        <div id="prixTerrassement" class="block_affichage_prix text-center font-weight-bold g-font-size-30 border-dark border">

                        </div>
                        <I id="rappel">
                        </I>
                    </div>
                </div>
            </div>

            <div id="table_form_terrassement">
                {{ include('@HomeConstructBuild/Default/complex-table-terrassement.html.twig') }}
            </div>
        <div class="block_button_backnext" class="media-body align-self-center">
            <a id="button_back"
               class=" btn btn-xl u-btn-lightblue-v3 g-width-160--md g-font-size-default g-ml-10"
               href="{{ path('home_construct_prepa_acces_terrain_profile',{'id':prepaAccesTerrain.id}) }}" data-speed="350">
                <div id="icone_plus_add" class="fas fa-reply"></div>
                Terminer
            </a>
        </div>
        {% endif %}
    {% endblock sub_content %}
{% endblock content %}

{% block javascripts %}
    {{ parent() }}
    <script>
        function showGrey(id) {
            var item = 'champSelect' + id;
            document.getElementById(item).style.backgroundColor = "rgba(142, 142, 142, 0.4)";
        }

        function hideGrey(id) {
            var item = 'champSelect' + id;
            document.getElementById(item).style.backgroundColor = "white";
            var item ='block_description_tache' + id;
            document.getElementById(item).style.display = "none";
        }

        $tailles = {{ tailles|json_encode|raw }};
        $types = {{ types|json_encode|raw }};
        $travaux = {{ travaux|json_encode|raw }};
        $evacuation = {{ evacuation|json_encode|raw }};
        $tarifs = {{ tarifs|json_encode|raw }};

        //script pour les arbre
        $typeArbre = $('#homeconstruct_buildbundle_arbre_typeArbre');
        $tailleArbre = $('#homeconstruct_buildbundle_arbre_tailleArbre');
        $prixAbattageNettoyage = $('#homeconstruct_buildbundle_arbre_prixAbattageNettoyage');
        $prixDessouchage = $('#homeconstruct_buildbundle_arbre_prixDessouchage');
        $quantite = $('#homeconstruct_buildbundle_arbre_quantite');

        $('#prixArbre').html(calculPrixArbre($typeArbre, $tailleArbre, $prixAbattageNettoyage, $prixDessouchage, $quantite)+"€");

        if($typeArbre.val() != ""){
            $('#block_checked_type').html("<i class='fas fa-check-circle variable-presente'></i>");
            $('#prix_type_arbre').html($types[$typeArbre.val()-1]['prix']);
        }else{
            $('#block_checked_type').html("<i class='fas fa-check-circle variable-non-presente'></i>");
            $('#prix_type_arbre').html("<I>Non calculable pour le moment</I>");
        }
        if($tailleArbre.val() != ""){
            $('#homeconstruct_buildbundle_arbre_prixAbattageNettoyage').attr('min', $tailles[$tailleArbre.val()-1]['tarifAbattageNettoyageMin']);
            $('#homeconstruct_buildbundle_arbre_prixAbattageNettoyage').attr('max', $tailles[$tailleArbre.val()-1]['tarifAbattageNettoyageMax']);
            //$('#homeconstruct_buildbundle_arbre_prixAbattageNettoyage').attr('value', $tailles[$tailleArbre.val()-1]['tarifAbattageNettoyageMax']);
            $('#homeconstruct_buildbundle_arbre_prixDessouchage').attr('min', $tailles[$tailleArbre.val()-1]['tarifDessouchageMin']);
            $('#homeconstruct_buildbundle_arbre_prixDessouchage').attr('max', $tailles[$tailleArbre.val()-1]['tarifDessouchageMax']);
            //$('#homeconstruct_buildbundle_arbre_prixDessouchage').attr('value', $tailles[$tailleArbre.val()-1]['tarifDessouchageMax']);
            $('#valeur_abattageNettoyage').html($('#homeconstruct_buildbundle_arbre_prixAbattageNettoyage').val());
            $('#abattage_nettoyage').html($('#homeconstruct_buildbundle_arbre_prixAbattageNettoyage').val());
            $('#valeur_dessouchage').html($('#homeconstruct_buildbundle_arbre_prixDessouchage').val());
            $('#dessouchage').html($('#homeconstruct_buildbundle_arbre_prixDessouchage').val());
        }else{
            $('#valeur_abattageNettoyage').html($('#homeconstruct_buildbundle_arbre_prixAbattageNettoyage').val());
            $('#abattage_nettoyage').html($('#homeconstruct_buildbundle_arbre_prixAbattageNettoyage').val());
            $('#valeur_dessouchage').html($('#homeconstruct_buildbundle_arbre_prixDessouchage').val());
            $('#dessouchage').html($('#homeconstruct_buildbundle_arbre_prixDessouchage').val());
        }

        $('#homeconstruct_buildbundle_arbre_typeArbre').on('change', function(){
            if($(this).val() != ""){
                $('#block_checked_type').html("<i class='fas fa-check-circle variable-presente'></i>");
                $('#prix_type_arbre').html($types[$(this).val()-1]['prix']+"€");
                $prixArbre = calculPrixArbre($(this), $tailleArbre, $prixAbattageNettoyage, $prixDessouchage, $quantite);
                $('#prixArbre').html($prixArbre+"€");
            }else{
                $('#block_checked_type').html("<i class='fas fa-check-circle variable-non-presente'></i>");
                $('#prix_type_arbre').html("<I>Non calculable pour le moment</I>");
            }
        });

        $('#homeconstruct_buildbundle_arbre_tailleArbre').on('change', function(){
            if($(this).val() != "" ){
                $('#homeconstruct_buildbundle_arbre_prixAbattageNettoyage').attr('min', $tailles[$(this).val()-1]['tarifAbattageNettoyageMin']);
                $('#homeconstruct_buildbundle_arbre_prixAbattageNettoyage').attr('max', $tailles[$(this).val()-1]['tarifAbattageNettoyageMax']);
                $('#homeconstruct_buildbundle_arbre_prixAbattageNettoyage').attr('value', $tailles[$(this).val()-1]['tarifAbattageNettoyageMax']);
                $('#homeconstruct_buildbundle_arbre_prixDessouchage').attr('min', $tailles[$(this).val()-1]['tarifDessouchageMin']);
                $('#homeconstruct_buildbundle_arbre_prixDessouchage').attr('max', $tailles[$(this).val()-1]['tarifDessouchageMax']);
                $('#homeconstruct_buildbundle_arbre_prixDessouchage').attr('value', $tailles[$(this).val()-1]['tarifDessouchageMax']);
                $('#valeur_abattageNettoyage').html($tailles[$(this).val()-1]['tarifDessouchageMax']);
                $('#abattage_nettoyage').html($('#homeconstruct_buildbundle_arbre_prixAbattageNettoyage').val());
                $('#valeur_dessouchage').html($tailles[$(this).val()-1]['tarifDessouchageMax']);
                $('#dessouchage').html($('#homeconstruct_buildbundle_arbre_prixDessouchage').val());
                $prixArbre = calculPrixArbre($typeArbre, $(this), $prixAbattageNettoyage, $prixDessouchage, $quantite);
                $('#prixArbre').html($prixArbre+"€");
            }
        });

        $('#homeconstruct_buildbundle_arbre_prixAbattageNettoyage').on('change',function(){
            $('#abattage_nettoyage').html($(this).val());
            $('#valeur_abattageNettoyage').html($(this).val());
            $prixArbre = calculPrixArbre($typeArbre, $tailleArbre, $(this), $prixDessouchage, $quantite);
            $('#prixArbre').html($prixArbre+"€");
        });

        $('#homeconstruct_buildbundle_arbre_prixDessouchage').on('change', function(){
            $('#dessouchage').html($(this).val());
            $('#valeur_dessouchage').html($(this).val());
            $prixArbre = calculPrixArbre($typeArbre, $tailleArbre, $prixAbattageNettoyage, $(this), $quantite);
            $('#prixArbre').html($prixArbre+"€");
        });

        $('#homeconstruct_buildbundle_arbre_quantite').on('change', function(){
            $prixArbre = calculPrixArbre($typeArbre, $tailleArbre, $prixAbattageNettoyage, $prixDessouchage, $(this));
            $('#prixArbre').html($prixArbre+"€");
        });

        //estimation du prix de l'arbre
        function calculPrixArbre($typeArbre, $tailleArbre, $prixAbattageNettoyage, $prixDessouchage, $quantite){
            $prixArbre = 0;
            if($typeArbre.val() !== "" && $tailleArbre.val() !== "" && $prixAbattageNettoyage.val() !== "", $prixDessouchage.val() !== "", $quantite.val() !== ""){
                $prixType = $types[$typeArbre.val()-1]['prix'];
                $taille = $tailles[$tailleArbre.val()-1]['taille'];
                $prixArbre = (parseFloat($prixType) * parseFloat($quantite.val()) * parseFloat($taille)) + parseFloat($prixAbattageNettoyage.val()) + parseFloat($prixDessouchage.val());
                if($quantite.val() > 5 ){
                    $prixArbre += 390 + ($quantite.val() - 5) * 60;
                }else{
                    $prixArbre += $tarifs[$quantite.val()-1]['prix'];
                }
                return $prixArbre;
            }else{
                return 0;
            }
        }

        //script pour les terrassements
        $typeTravaux = $('#homeconstruct_buildbundle_terrassement_travaux');
        $typeEvacuation = $('#homeconstruct_buildbundle_terrassement_evacuation');
        $profondeur = $('#homeconstruct_buildbundle_terrassement_profondeur');
        $altimetrie = $('#homeconstruct_buildbundle_terrassement_altimetrie');
        $longueur = $('#homeconstruct_buildbundle_terrassement_longueur');
        $largeur = $('#homeconstruct_buildbundle_terrassement_largeur');
        $('#prixTerrassement').html(calculPrixTerrassement($typeTravaux, $typeEvacuation, $longueur, $largeur, $profondeur, $altimetrie)+"€");
        if($typeTravaux.val() != ""){
            $('#block_checked_travaux').html("<i class='fas fa-check-circle variable-presente'></i>");
            $('#prixTerrassement').html(calculPrixTerrassement($typeTravaux, $typeEvacuation, $longueur, $largeur, $profondeur, $altimetrie)+"€");
            $('#prix-travaux').html($travaux[$typeTravaux.val()-1]['prix']+"€");
        }else{
            $('#block_checked_travaux').html("<i class='fas fa-check-circle variable-non-presente'></i>");
            $('#prix-travaux').html("<I>Non calculable pour le moment</I>");
        }

        if($typeEvacuation.val() != "") {
            $('#block_checked_evacuation').html("<i class='fas fa-check-circle variable-presente'></i>");
            $('#prixTerrassement').html(calculPrixTerrassement($typeTravaux, $typeEvacuation, $longueur, $largeur, $profondeur, $altimetrie)+"€");
            $('#prix-evacuation').html($evacuation[$typeEvacuation.val()-1]['prix']+"€");
        }else{
            $('#block_checked_evacuation').html("<i class='fas fa-check-circle variable-non-presente'></i>");
            $('#prix-evacuation').html("<I>Non calculable pour le moment</I>");
        }

        $('#homeconstruct_buildbundle_terrassement_travaux').on('change', function(){
            $('#prixTerrassement').html(calculPrixTerrassement($(this), $typeEvacuation, $longueur, $largeur, $profondeur, $altimetrie)+"€");
            if(($(this).val()) != ""){
                $('#block_checked_travaux').html("<i class='fas fa-check-circle variable-presente'></i>");
                $('#prix-travaux').html($travaux[$(this).val()-1]['prix']+"€");
            }else{
                $('#block_checked_travaux').html("<i class='fas fa-check-circle variable-non-presente'></i>");
                $('#prix-travaux').html("<I>Non calculable pour le moment</I>");
            }
        });

        $('#homeconstruct_buildbundle_terrassement_evacuation').on('change',function(){
            $('#prixTerrassement').html(calculPrixTerrassement($typeTravaux, $(this), $longueur, $largeur, $profondeur, $altimetrie)+"€");
            if( ($(this).val()) != ""){
                $('#block_checked_evacuation').html("<i class='fas fa-check-circle variable-presente'></i>");
                $('#prix-evacuation').html($evacuation[$(this).val()-1]['prix']+"€");
            }else{
                $('#block_checked_evacuation').html("<i class='fas fa-check-circle variable-non-presente'></i>");
                $('#prix-evacuation').html("<I>Non calculable pour le moment</I>");
            }
        });
        /*
        $('#homeconstruct_buildbundle_terrassement_profondeur').on('change', function(){
            $prixTerrassement =  calculPrixTerrassement($typeTravaux, $typeEvacuation, $longueur, $largeur, $(this), $altimetrie);
            $('#prixTerrassement').html($prixTerrassement+"€");
        });

        $('#homeconstruct_buildbundle_terrassement_altimetrie').on('change', function(){
            $prixTerrassement = calculPrixTerrassement($typeTravaux, $typeEvacuation, $longueur, $largeur, $profondeur, $(this));
            $('#prixTerrassement').html($prixTerrassement+"€");
        });*/

        //sur changement des inputs
        $('input').on('input', function(){
            calculPrixTerrassement($typeTravaux, $typeEvacuation, $longueur, $largeur, $profondeur, $altimetrie);
        });

        //estimation du prix terrassement
        function calculPrixTerrassement($typeTravaux, $typeEvacuation, $longueur, $largeur, $profondeur, $altimetrie) {
            $prixTerrassement = 0;
            if($typeTravaux.val() != "" && $typeEvacuation.val() != "" && $longueur.val() != "" && $largeur.val() != "" && $profondeur.val() != "" && $altimetrie.val() != ""){
                $m2 = $longueur.val() * $largeur.val();
                if($profondeur.val() > 0 && $altimetrie.val() != 0){
                    $altimetrie.val("");
                    $profondeur.val("");
                    alert("L'altimetrie et la profondeur ne peuvent être à la fois supérieur à 0. Mettez 0 pour l'un des 2 champs.");
                    return 0;
                }
                if($profondeur.val() > 0){
                    $prixTerrassement = (parseFloat($travaux[$typeTravaux.val()-1]['prix']) * $m2 * $profondeur.val())
                        + (parseFloat($evacuation[$typeEvacuation.val()-1]['prix']) * $m2 * $profondeur.val());
                }
                if($altimetrie.val() > 0){
                    $prixTerrassement = (parseFloat($travaux[$typeTravaux.val()-1]['prix']) * $m2 * $altimetrie.val())
                        + (parseFloat($evacuation[$typeEvacuation.val()-1]['prix']) * $m2 * $altimetrie.val());
                }
            }
            $('#prixTerrassement').html($prixTerrassement);
            return $prixTerrassement;
        }
    </script>

{% endblock %}